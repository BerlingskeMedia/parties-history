var svg=$('<svg xmlns="http://www.w3.org/2000/svg" version="1.1"></svg>');var timeline=$('<svg xmlns="http://www.w3.org/2000/svg" version="1.1"></svg>');var partyData=[];var electionData=[];var dotGroupsArray=[];var xmls=[];var timelineData=[];var timelineGrid=0;var pollsNum=0;var maxProcent=0;var maxMandates=0;var minProcent=100;var minMandates=100;var months=[];months[1]="januar";months[2]="febuar";months[3]="marts";months[4]="april";months[5]="maj";months[6]="juni";months[7]="juli";months[8]="august";months[9]="september";months[10]="oktober";months[11]="november";months[12]="december";$.ajax({type:"GET",url:"../valgresultater.xml",dataType:"xml",success:function(a){$(a).find("datetime").each(function(){electionData[$(this).text().substr(0,4)]=$(this).text().substr(0,10)})}});$.ajax({type:"GET",url:"../parties.xml",dataType:"xml",success:function(b){var a="";var c="";$(b).find("party").each(function(){var d=parseFloat($(this).find("id").text());partyData[d]=[];partyData[d].id=$(this).find("id").text();partyData[d].letter=$(this).find("letter").text();partyData[d].shortname=$(this).find("shortname").text()});a+='<path class="procent one" stroke="#bb252e" fill="none"/>';a+='<path class="procent two" stroke="#136a90" fill="none"/>';a+='<path class="mandates one" stroke="#bb252e" fill="none"/>';a+='<path class="mandates two" stroke="#136a90" fill="none"/>';svg.append('<g id="chart-lines">'+a+c+'</g><g id="chart-dots"/><g id="chart-markers"/>');timeline.append('<g id="timeline-lines">'+a+'</g><g id="timeline-markers"/>');setTimeout(installation(),2)}});var installation=function(){var b=new Date().getFullYear();for(var a=b;a>=2010;a--){$.ajax({type:"GET",url:"../"+a+"/pollofpolls.xml",dataType:"xml",async:false,success:function(c){$.merge(xmls,$(c))}});if(a==2010){makeTimeline(xmls)}}addEvents()};var makeTimeline=function(w){var h=$(w).find("poll");var k=h.length;var B=35;var A=$("datetime",h[k-1]).text().substr(0,10);var r=$("datetime",h[0]).text().substr(0,10);var I;var e=A;var j=917/(dateDifference(A,r));var s=0;var M="";var q;var K;var m="blue";var t=0;var E=0;var G;var O=12;var n="";var D="";timelineGrid=j;for(var L=k;L--;){var b=h[L];var P=$("datetime",b).text().substr(0,10);var d=0;var y=0;var l=0;var C=0;if(L!==0){I=$("datetime",h[L-1]).text().substr(0,10)}else{I=P}var p=parseFloat(P.substr(0,4));var g=$("entry",b);var c=g.length;G=dateDifference(P,I);for(var N=t;N<=(t+G);N++){timelineData[N]=[];timelineData[N].counter=E;timelineData[N].date=P}O=O+(j*dateDifference(e,P));for(var J=c;J--;){var z=g[J];K=$("id",z).text();var H=parseFloat($("percent",z).text());var f=parseFloat($("mandates",z).text());var x=$("supports",z).text();if(x==1||x==9){d=d+H;l=l+f;if(partyData[K].letter=="A"){m="red"}}else{y=y+H;C=C+f}if(p!=s){q=O-(dateDifference(p+"-01-01",P)*j);if(q<0){q=12}M+='<g class="year-marker">';M+='<text x="'+q+'" y="10" fill="#D2D2D2" font-size="11" text-anchor="middle">'+p+"</text>";M+='<line x1="'+q+'" y1="12" x2="'+q+'" y2="17" fill="none" stroke="#D2D2D2" stroke-width="1"/>';M+="</g>";s=p}}if(m==="blue"){var v=d;d=y;y=v}var u=(d/50)*B;u=(B-u)-u;u=u+65;var F=(y/50)*B;F=(B-F)-F;F=F+65;if(n===""){n="M 0 "+u;n+=" L "+O+" "+u;D="M 0 "+F;D+=" L "+O+" "+F}else{n+=" L "+O+" "+u;D+=" L "+O+" "+F;if(L===0){n+=" L 940 "+u;D+=" L 940 "+F}}if(d>maxProcent){maxProcent=d}else{if(y>maxProcent){maxProcent=y}}if(l>maxMandates){maxMandates=l}else{if(C>maxMandates){maxMandates=C}}if(d<minProcent){minProcent=d}else{if(y<minProcent){minProcent=y}}if(l<minMandates){minMandates=l}else{if(C<minMandates){minMandates=C}}if(G===0){G=1}t=t+G;E++;e=P}$("#timeline-markers",timeline).append(M);$(".one",timeline).attr("d",n).attr("stroke-width",1.5);$(".two",timeline).attr("d",D).attr("stroke-width",1.5);$("#timeline").append(timeline).html($("#timeline").html());$("#zoomer, #timeline .info").show();makeSVG(w)};var makeSVG=function(aC,j,z){var ao=$(aC).find("poll");var Q;var n;var aw;var v=0;var m;var u;var R=0;var H=0;var O=0;var ar=17;var S=0;var af="";var c=0;var C="";var F=0;var ay;var I;var ab;var a;var ax;var ad;var K;var ai="";var e="";var ak="";var d="";var y=17;if(z===undefined){z=ao.length-1;pollsNum=z;j=0;m=z;aw=1}else{$("#chart-dots g",svg).remove();$("#chart-markers g",svg).remove();$("#chart svg, #chart .lines").remove();m=v+(z-j)}var D=$("datetime",ao[z]).text().substr(0,10);var W=$("datetime",ao[j]).text().substr(0,10);var T=D;Q=905/(dateDifference(D,W));dotGroupsArray=[];dotGroupsArray.length=0;for(var J=z;J>=j;J--){var t=ao[J];n=$("datetime",t).text().substr(0,10);var al=parseFloat(n.substr(0,4));var P=n.substr(5,2);var q=$("respondents",t).text();var ac=$("entry",t);var s=ac.length;var V=0;var av=0;var aD=0;var r=0;var ad="";var K="";var k="blue";y=y+(Q*dateDifference(T,n));var f=ac.sort(function(o,i){var aE=$(i).find("party").find("letter").text();var x=$(o).find("party").find("letter").text();return(aE<x?-1:(aE>x?+1:0))});for(var G=s;G--;){var A=f[G];var U=$("id",A).text();var ah=parseFloat($("percent",A).text());var N=parseFloat($("mandates",A).text());var an=$("supports",A).text();var L=partyData[U].shortname;if(an==1||an==9){V=V+ah;aD=aD+N;ad+=L+", ";if(partyData[U].letter=="A"){k="red"}}else{av=av+ah;r=r+N;K+=L+", "}}if(k==="blue"){var w=V;var Z=aD;V=av;av=w;aD=r;r=Z}var Y=((V-minProcent)/(maxProcent-minProcent))*240;Y=260-(Y);var aA=((av-minProcent)/(maxProcent-minProcent))*240;aA=260-(aA);var p=((aD-minMandates)/(maxMandates-minMandates))*240;p=260-(p);var aa=((r-minMandates)/(maxMandates-minMandates))*240;aa=260-(aa);if(ai===""){ai+=" M "+y+" "+Y;e+=" M "+y+" "+aA;ak+=" M "+y+" "+p;d+=" M "+y+" "+aa}else{ai+=" L "+y+" "+Y;e+=" L "+y+" "+aA;ak+=" L "+y+" "+p;d+=" L "+y+" "+aa}if(!dotGroupsArray[F]){dotGroupsArray[F]=[];dotGroupsArray[F].x=y;dotGroupsArray[F].date=n;dotGroupsArray[F].respondents=q;dotGroupsArray[F].supportOneProcent=V;dotGroupsArray[F].supportTwoProcent=av;dotGroupsArray[F].supportOneMandates=aD;dotGroupsArray[F].supportTwoMandates=r;dotGroupsArray[F].supportOnePartys=ad;dotGroupsArray[F].supportTwoPartys=K;dotGroupsArray[F].supportOneColor=k;dotGroupsArray[F].procentDots+='<circle class ="red procent" cx="'+y+'" cy="'+Y+'" r="6" fill="transparent" stroke="#bb252e" stroke-width="0" date="'+n+'" procent="'+V+'" mandates="'+aD+'"/>';dotGroupsArray[F].mandatesDots+='<circle class ="red mandates" cx="'+y+'" cy="'+p+'" r="6" fill="transparent" stroke="#bb252e" stroke-width="0"/>';dotGroupsArray[F].procentDots+='<circle class ="blue procent" cx="'+y+'" cy="'+aA+'" r="6" fill="transparent" stroke="#136a90" stroke-width="0" date="'+n+'" procent="'+av+'" mandates="'+r+'"/>';dotGroupsArray[F].mandatesDots+='<circle class ="blue mandates" cx="'+y+'" cy="'+aa+'" r="6" fill="transparent" stroke="#136a90" stroke-width="0"/>'}if(al!=R){if(electionData[al]!==undefined){ar=y-(dateDifference(electionData[al],n)*Q);af+='<g class="election-marker">';af+='<line class="indicator" x1="'+ar+'" y1="20" x2="'+ar+'" y2="300" stroke="#76C276" stroke-width="0.3" />';af+='<text x="'+ar+'" y="14" fill="#76C276" font-size="11" text-anchor="middle">Valget '+al+"</text>";af+="</g>"}ar=y-(dateDifference(al+"-01-01",n)*Q);if(ar>0){af+='<g class="year-marker">';af+='<text x="'+ar+'" y="290" fill="#D2D2D2" font-size="12" text-anchor="middle">'+al+"</text>";af+='<g class="marker-arrow">';af+='<line x1="'+(ar+16)+'" y1="286" x2="'+(ar+22)+'" y2="286" fill="none" stroke="#D2D2D2" stroke-width="2"/>';af+='<path d="M '+(ar+22)+" 282 L "+(ar+28)+" 286 L "+(ar+22)+' 290" fill="#D2D2D2" stroke="#D2D2D2" stroke-width="1"/>';af+="</g>";af+="</g>";H++}R=al}if(P!=O){ar=y-(dateDifference(al+"-"+P+"-01",n)*Q);if((ar-S)>c&&ar>9){af+='<g class="month-marker">';af+='<text x="'+ar+'" y="312" fill="#D2D2D2" font-size="11" text-anchor="middle">'+months[parseInt(P,10)].substr(0,3)+".</text>";af+='<line x1="'+ar+'" y1="300" x2="'+ar+'" y2="293" fill="none" stroke="#D2D2D2" stroke-width="1"/>';af+="</g>";S=ar}O=P;c=19}F++;T=n}if(H===0){af+='<g class="year-marker">';af+='<text x="17" y="290" fill="#D2D2D2" font-size="12" text-anchor="middle">'+al+"</text>";af+='<g class="marker-arrow">';af+='<line x1="33" y1="286" x2="39" y2="286" fill="none" stroke="#D2D2D2" stroke-width="2"/>';af+='<path d="M 39 282 L 45 286 L 39 290" fill="#D2D2D2" stroke="#D2D2D2" stroke-width="1"/>';af+="</g>";af+="</g>";H++}$("#chart-markers",svg).append(af);if(H===1){$(".marker-arrow",svg).show()}var az=minProcent;var X=minMandates;var aq=(maxProcent-az)/6;var l=(maxMandates-X)/6;var g="";for(var J=0;J<7;J++){g='<span class="lines"><p altValue="'+parseInt(X,10)+'">'+parseInt(az,10)+"</p></span>"+g;az=az+aq;X=X+l}$("#chart").append(g);$("#chart .lines:first").addClass("top");if($("#mandates-toggle").hasClass("active")){$("#chart-lines .procent",svg).hide();$("#chart-lines .mandates",svg).show()}$(".one.procent",svg).attr("d",ai).attr("stroke-width",4);$(".two.procent",svg).attr("d",e).attr("stroke-width",4);$(".one.mandates",svg).attr("d",ak).attr("stroke-width",4);$(".two.mandates",svg).attr("d",d).attr("stroke-width",4);var ae;var at;var aj;for(var J=v;J<=m;J++){C+='<g date="'+dotGroupsArray[J].date+'" respondents="'+dotGroupsArray[J].respondents+'"';C+=' supportOneProcent="'+dotGroupsArray[J].supportOneProcent+'"';C+=' supportTwoProcent="'+dotGroupsArray[J].supportTwoProcent+'"';C+=' supportOneMandates="'+dotGroupsArray[J].supportOneMandates+'"';C+=' supportTwoMandates="'+dotGroupsArray[J].supportTwoMandates+'"';C+=' supportOnePartys="'+dotGroupsArray[J].supportOnePartys+'"';C+=' supportTwoPartys="'+dotGroupsArray[J].supportTwoPartys+'"';C+=' supportOneColor="'+dotGroupsArray[J].supportOneColor+'"';C+=">";C+='<line class="guide" x1="'+dotGroupsArray[J].x+'" y1="20" x2="'+dotGroupsArray[J].x+'" y2="300" stroke="#bdbec0" stroke-width="0.3" visibility="hidden"/>';C+=dotGroupsArray[J].procentDots;C+=dotGroupsArray[J].mandatesDots;if(J===v){ae=dotGroupsArray[J].x-5}else{ae=dotGroupsArray[J].x-((dotGroupsArray[J].x-dotGroupsArray[J-1].x)/2)}if(J===m){aj=dotGroupsArray[J].x}else{at=dotGroupsArray[J].x+((dotGroupsArray[J+1].x-dotGroupsArray[J].x)/2);aj=at-ae}C+='<rect class="overlay" x="'+ae+'" y="20" width="'+aj+'" height="245" fill="transparent"/>';C+="</g>";if(J==m){ay=dotGroupsArray[J].supportOneProcent;I=dotGroupsArray[J].supportTwoProcent;ab=dotGroupsArray[J].supportOneMandates;a=dotGroupsArray[J].supportTwoMandates;ax=dotGroupsArray[J].supportOneColor;ad=dotGroupsArray[J].supportOnePartys;K=dotGroupsArray[J].supportTwoPartys;n=dotGroupsArray[J].date.split("-");u="Berlingske Barometer "+parseFloat(n[2])+". "+months[parseFloat(n[1])]+" "+n[0]}}$("#chart-dots",svg).append(C);var ap=ay.toFixed(1).toString().replace(".",",")+"%";var h=I.toFixed(1).toString().replace(".",",")+"%";var ag=ab;var b=a;var B=$("#blockview-first-bottom .blue");var E=$("#blockview-first-bottom .red");var au=100-(ay+I);if(au>0){ay=ay+au}else{if(au<0){ay=au+ay}}if(aw!==undefined){B=$("#blockview-first-bottom .blue, #blockview-top .blue");E=$("#blockview-first-bottom .red, #blockview-top .red")}$("#blockview-first-bottom .red .info").html(u).show();$("#blockview-top, #blockview-first-bottom").show();if(ax=="red"){E.animate({width:ay+"%"},700);$(".procent",E).attr("altValue",ag).html(ap);$("#blockview-first-bottom .red .partys").html(ad.substr(0,ad.length-2));B.animate({width:I+"%"},700);$(".procent",B).attr("altValue",b).html(h);$("#blockview-first-bottom .blue .partys").html(K.substr(0,K.length-2))}else{E.animate({width:I+"%"},700);$(".procent",E).attr("altValue",b).html(h);$("#blockview-first-bottom .red .partys").html(K.substr(0,K.length-2));B.animate({width:ay+"%"},700);$(".procent",B).attr("altValue",ag).html(ap);$("#blockview-first-bottom .blue .partys").html(ad.substr(0,ad.length-2))}$("#chart").append(svg).html($("#chart").html());$("#loader").fadeOut(900);if(("ontouchstart" in window)===true){var am;var M;var aB=[];$("#chart").bind("touchmove touchstart",function(i){i.preventDefault();$.map(aB,function(x,o){removeDotEvent(x)+o});aB=[];am=i.originalEvent.touches[0]||i.originalEvent.changedTouches[0];M=$(document.elementFromPoint(am.pageX,am.pageY)).parent();aB.push($(M));addDotEvent(M)})}else{$("#chart-dots g").mouseover(function(){addDotEvent($(this))}).mouseleave(function(){removeDotEvent($(this))})}};var addEvents=function(){$("#toggles").click(function(){$("#blockview-first-bottom div, #blockview-top div").each(function(){var b=$(".procent",this).html();$(".procent",this).html($(".procent",this).attr("altValue"));$(".procent",this).attr("altValue",b)});$(".lines").each(function(){var b=$("p",this).html();$("p",this).html($("p",this).attr("altValue"));$("p",this).attr("altValue",b)});$("#chart-lines path").hide();if($("#mandates-toggle").hasClass("active")){$("#chart-lines .procent").show()}else{$("#chart-lines .mandates").show()}$("#toggles p").toggleClass("active")});var a=timelineGrid*60;$("#zoomer .left").draggable({axis:"x",containment:"#zoomer",grid:[timelineGrid,0],drag:function(d,e){var b=e.position.left;var f=$("#zoomer .right").position();if((b+a)>f.left){e.position.left=f.left-a;b=e.position.left}var c=(f.left-b)+10;$("#zoomer .bottom").css({left:b,width:c});$("#zoomer .left-overlay").css("width",b);timelineTooltip();$("p",this).show();$("#timeline-markers").show()}});$("#zoomer .right").draggable({axis:"x",containment:"#zoomer",grid:[timelineGrid,0],drag:function(e,f){var c=$("#zoomer .left").position();var g=f.position.left;if((g-a)<c.left){f.position.left=c.left+a;g=f.position.left}var d=(g-c.left)+10;var b=(940-g)-12;$("#zoomer .bottom").css({left:c.left,width:d});$("#zoomer .right-overlay").css("width",b);timelineTooltip();$("p",this).show();$("#timeline-markers").show()}});$("#zoomer .bottom").draggable({axis:"x",containment:"#zoomer",snap:".marker",drag:function(f,g){var b=g.position;var e=$(this).width();var d=(b.left+e)-11;var c=(940-d)-12;$("#zoomer .left").css("left",b.left);$("#zoomer .right").css("left",d);$("#zoomer .left-overlay").css("width",b.left);$("#zoomer .right-overlay").css("width",c);timelineTooltip();$("#zoomer .left p, #zoomer .right p").show();$("#timeline-markers").show()}});$("#zoomer .left, #zoomer .right, #zoomer .bottom").on("dragstop",function(c,d){var b=timelineTooltip();$("#loader").show();$("#timeline-markers, #zoomer .left p, #zoomer .right p").hide();setTimeout(function(){makeSVG(xmls,b[0],b[1])},1)})};var addDotEvent=function(f){var e=$(f).attr("date").split("-");var d="Berlingske Barometer "+parseFloat(e[2])+". "+months[parseFloat(e[1])]+" "+e[0];var g="procent";if($("#mandates-toggle").hasClass("active")){g="mandates"}$(f).find("circle."+g).attr({fill:"#ffffff","stroke-width":"2"});$(f).find(".guide").attr("visibility","visible");supportOneProcent=parseFloat($(f).attr("supportOneProcent"));supportTwoProcent=parseFloat($(f).attr("supportTwoProcent"));supportOneMandates=$(f).attr("supportOneMandates");supportTwoMandates=$(f).attr("supportTwoMandates");supportOneColor=$(f).attr("supportOneColor");supportOnePartys=$(f).attr("supportOnePartys");supportTwoPartys=$(f).attr("supportTwoPartys");var c=supportOneMandates;var i=supportTwoMandates;var a=supportOneProcent.toFixed(1).toString().replace(".",",")+"%";var h=supportTwoProcent.toFixed(1).toString().replace(".",",")+"%";if($("#procent-toggle").hasClass("active")){c=supportOneProcent.toFixed(1).toString().replace(".",",")+"%";i=supportTwoProcent.toFixed(1).toString().replace(".",",")+"%";a=supportOneMandates;h=supportTwoMandates}var b=100-(supportOneProcent+supportTwoProcent);if(b>0){supportOneProcent=supportOneProcent+b}else{if(b<0){supportOneProcent=b+supportOneProcent}}if(supportOneColor=="red"){$("#blockview-first-bottom .red").width(supportOneProcent+"%");$("#blockview-first-bottom .red .procent").attr("altValue",a).html(c);$("#blockview-first-bottom .red .partys").html(supportOnePartys.substr(0,supportOnePartys.length-2));$("#blockview-first-bottom .blue").width(supportTwoProcent+"%");$("#blockview-first-bottom .blue .procent").attr("altValue",h).html(i);$("#blockview-first-bottom .blue .partys").html(supportTwoPartys.substr(0,supportTwoPartys.length-2))}else{$("#blockview-first-bottom .red").width(supportTwoProcent+"%");$("#blockview-first-bottom .red .procent").attr("altValue",h).html(i);$("#blockview-first-bottom .red .partys").html(supportTwoPartys.substr(0,supportTwoPartys.length-2));$("#blockview-first-bottom .blue").width(supportOneProcent+"%");$("#blockview-first-bottom .blue .procent").attr("altValue",a).html(c);$("#blockview-first-bottom .blue .partys").html(supportOnePartys.substr(0,supportOnePartys.length-2))}$("#blockview-first-bottom .red .info").html(d)};var removeDotEvent=function(a){$(a).find("circle").attr({fill:"transparent","stroke-width":"0"});$(a).find(".guide").attr("visibility","hidden")};var timelineTooltip=function(){var a=$("#zoomer .left p");var h=$("#zoomer .right p");var g=($("#zoomer .left").position()).left;var f=($("#zoomer .right").position()).left;var b=parseInt(g/timelineGrid,10);var e=parseInt((f-10)/timelineGrid,10);if(b>timelineData.length-1){b=timelineData.length-1}else{if(b<0){b=0}}if(e>timelineData.length-1){e=timelineData.length-1}else{if(e<0){e=0}}var c=timelineData[b].date.split("-");var j=timelineData[e].date.split("-");var d=(a.width()/2);var i=(h.width()/2);if((g+d)<50){d=-d-((g+d)-50)}else{d=-(d-2)}if((f+i)>930){i=-i-((f+i)-930)}else{i=-(i-2)}a.text(parseFloat(c[2])+". "+months[parseFloat(c[1])]).css("left",d);h.text(parseFloat(j[2])+". "+months[parseFloat(j[1])]).css("left",i);e=pollsNum-timelineData[e].counter;b=pollsNum-timelineData[b].counter;return[e,b]};var dateDifference=function(e,d){var a=new Date(e);var b=new Date(d);var c=((b-a)/(1000*60*60*24));return c};