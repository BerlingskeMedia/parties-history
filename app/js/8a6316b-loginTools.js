var displayLoginFailed=function(){var url=window.location.href,isLoginPage=window.location.pathname==Routing.generate("bmsso_login"),previousLoginFailed="loginFailed"==url.substring(url.indexOf("#")+1);previousLoginFailed&&(isLoginPage||($("li.menu-login a").click(),$('[data-message="badLogin"]').show()),window.location.href=url.substring(0,url.indexOf("#")+1))},UserInfo=function(maxCount){function pushCallback(callback){"function"==typeof callback&&callbacks.push(callback)}function runCallbacks(){for(i=0;i<callbacks.length;i++)callbacks[i](data);callbacks=new Array}function refreshUserInfoCookie(){isBeingInitialized=!0;var queryParams={},queryVariableName=Math.random().toString(),queryVariableValue=Math.random().toString();queryParams[queryVariableName]=queryVariableValue,$.ajax(Routing.generate("bmsso_refresh_userinfo",queryParams),{success:function(){isBeingInitialized=!1,that.parseUserInfoCookie()}})}function isInitialized(){return void 0!==data&&void 0!==data.count}var data,that=this,isBeingInitialized=!1,callbacks=new Array;this.getUserInfo=function(callback){return pushCallback(callback),isInitialized()||isBeingInitialized?isBeingInitialized||(data.count>=maxCount?refreshUserInfoCookie():runCallbacks()):that.parseUserInfoCookie(),$(document).trigger("UserInfoInitialized",[data]),data},this.parseUserInfoCookie=function(){data=$.parseJSON($.cookie("userInfo")||"{}"),isInitialized()?isBeingInitialized||(data.count++,$.cookie("userInfo",JSON.stringify(data),{path:"/"}),runCallbacks()):refreshUserInfoCookie()}},LoginReady=function(){var mobileReady=!1,desktopReady=!1;this.setMobileReady=function(){mobileReady=!0},this.setDesktopReady=function(){desktopReady=!0},this.isDesktopAndMobileReady=function(){return desktopReady&&mobileReady}},triggerFormReadyEvent=function(userInfoObj){isUserLogIn(userInfoObj)?$(document).trigger("formLogoutButtonReadyEvent"):$(document).trigger("formLoginButtonReadyEvent")},isUserLogIn=function(userInfo){return null!==userInfo.username||null!==userInfo.email},setPathsForLogin=function(data){return data.paths={},data.paths.logout=Routing.generate("bmsso_logout"),data.paths.profile=Routing.generate("bmsso_profile"),data},generateDesktopLoginMarkup=function(data,userInfoObj,loginReady,parentElementSelector){userInfoObj.getUserInfo(function(userInfo){var userDisplayName=userInfo.username||userInfo.email,template="";data=setPathsForLogin(data),template=isUserLogIn(userInfo)?_.template($("script#desktopLoggedIn").html()):_.template($("script#desktopLoggedOut").html()),$(parentElementSelector).append(template({data:data,userDisplayName:userDisplayName})).promise().done(function(){loginReady.setDesktopReady(),loginReady.isDesktopAndMobileReady()&&triggerFormReadyEvent(userInfo)})})},generateMobileLoginMarkup=function(data,userInfoObj,loginReady,parentElementSelector){userInfoObj.getUserInfo(function(userInfo){var userDisplayName=userInfo.username||userInfo.email,template="";data=setPathsForLogin(data),template=isUserLogIn(userInfo)?_.template($("script#mobileLoggedIn").html()):_.template($("script#mobileLoggedOut").html()),$(parentElementSelector).append(template({data:data,userDisplayName:userDisplayName})).promise().done(function(){loginReady.setMobileReady(),loginReady.isDesktopAndMobileReady()&&triggerFormReadyEvent(userInfo)})})},initLoadModelDataByAjax=function(){$("body").on("click","[data-toggle=modal]",function(ev){var isContent=$($(this).attr("data-target")+" .modal-body").html().length>0;$(this).attr("data-href")&&0==isContent&&($($(this).attr("data-target")).modal("hide"),ev.preventDefault(),$($(this).attr("data-target")+" .modal-body").load($(this).attr("data-href"),function(){$($(this).attr("data-target")).modal("show")}))})};$(document).ready(function(){initLoadModelDataByAjax(),displayLoginFailed()});
